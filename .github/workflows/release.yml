name: Release

on:
  push:
    tags:
      - "*.*.*" # triggers on tags like 1.0.0, 2.3.1, etc.

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Run tests
        run: npm test

      - name: Build and package release
        run: npm run build:release

      - name: Generate release notes
        run: npm run release-notes

      - name: Validate release files
        run: |
          echo "üîç Validating release files..."
          required_files=(
            "./dist/main.js"
            "./dist/styles.css"
            "./dist/manifest.json"
            "./dist/database-worker.js"
            "./dist/assets/sql-wasm.js"
            "./dist/assets/sql-wasm.wasm"
            "./dist/README.md"
            "./dist/LICENSE"
            "./GITHUB_RELEASE_NOTES.md"
          )

          missing_files=()
          for file in "${required_files[@]}"; do
            if [[ ! -f "$file" ]]; then
              missing_files+=("$file")
            else
              echo "‚úÖ Found: $file"
            fi
          done

          if [[ ${#missing_files[@]} -gt 0 ]]; then
            echo "‚ùå Missing files:"
            printf '  - %s\n' "${missing_files[@]}"
            exit 1
          fi

          echo "‚úÖ All release files validated successfully!"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: ./GITHUB_RELEASE_NOTES.md
          files: |
            ./dist/main.js
            ./dist/styles.css
            ./dist/manifest.json
            ./dist/database-worker.js
            ./dist/assets/sql-wasm.js
            ./dist/assets/sql-wasm.wasm
            ./dist/README.md
            ./dist/LICENSE
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
